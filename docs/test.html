<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Unendlicher Boden + zentriertes Modell</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; touch-action: none; }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
    }
  </style>
</head>
<body>

<div id="controls">
  <label>
    <input type="checkbox" id="toggleCamera" checked>
    Enable AR Camera
  </label>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  arjs="sourceType: webcam; debugUIEnabled: false;"
>
  <!-- Kamera-Rig: Kamera schaut leicht nach unten -->
  <a-entity id="cameraRig" position="0 2 0" rotation="30 0 0">
    <a-entity id="mainCamera" camera position="0 0 5"></a-entity>
  </a-entity>

  <!-- Modell in Zentrum der Welt -->
  <a-entity
    id="model"
    gltf-model="test.gltf"
    position="0 0 0"
    scale="1 1 1"
    rotation="0 0 0"
  ></a-entity>

  <!-- Unendlicher Boden mit wiederholter Textur -->
  <a-plane
    id="groundPlane"
    visible="false"
    position="0 -0.01 0"
    rotation="-90 0 0"
    width="200"
    height="200"
    material="src: https://cdn.aframe.io/a-painter/images/floor.jpg; repeat: 100 100; roughness: 1; metalness: 0"
  ></a-plane>
</a-scene>

<script>
  const cameraRig = document.getElementById('cameraRig');
  const mainCamera = document.getElementById('mainCamera');
  const groundPlane = document.getElementById('groundPlane');
  const checkbox = document.getElementById('toggleCamera');

  let isTouching = false;
  let lastTouch = null;
  let startRotation = { x: 0, y: 0 };
  let initialDistance = null;
  let startZoom = 5;

  // Orbit + Zoom
  document.body.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      isTouching = true;
      lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      const rot = cameraRig.getAttribute('rotation');
      startRotation = { x: rot.x, y: rot.y };
    } else if (e.touches.length === 2) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      initialDistance = Math.sqrt(dx * dx + dy * dy);
      startZoom = mainCamera.getAttribute('position').z;
    }
  });

  document.body.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1 && isTouching) {
      const deltaX = e.touches[0].clientX - lastTouch.x;
      const deltaY = e.touches[0].clientY - lastTouch.y;
      let newRotY = startRotation.y - deltaX * 0.3;
      let newRotX = startRotation.x - deltaY * 0.3;
      newRotX = Math.max(-30, Math.min(60, newRotX));
      cameraRig.setAttribute('rotation', `${newRotX} ${newRotY} 0`);
    } else if (e.touches.length === 2 && initialDistance !== null) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const newDistance = Math.sqrt(dx * dx + dy * dy);
      const scale = initialDistance / newDistance;
      const newZ = Math.min(10, Math.max(1, startZoom * scale));
      mainCamera.setAttribute('position', `0 0 ${newZ}`);
    }
  });

  document.body.addEventListener('touchend', () => {
    isTouching = false;
    initialDistance = null;
  });

  // Toggle Kamera & Boden
  checkbox.addEventListener('change', () => {
    const video = document.querySelector('video');
    const isOn = checkbox.checked;
    if (video) video.style.display = isOn ? 'block' : 'none';
    groundPlane.setAttribute('visible', !isOn);
  });

  // Auf Start setzen
  window.addEventListener('load', () => {
    if (!checkbox.checked) {
      const video = document.querySelector('video');
      if (video) video.style.display = 'none';
      groundPlane.setAttribute('visible', true);
    }
  });
</script>

</body>
</html>
